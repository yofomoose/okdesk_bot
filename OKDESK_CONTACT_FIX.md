# Исправление привязки контактов в Okdesk

## Проблема

При создании заявок в Okdesk контакты не привязывались к заявкам, несмотря на то что они успешно создавались. В логах это выглядело следующим образом:

```
okdesk_bot_1 | INFO:services.okdesk_api:Создаем контакт с данными: {'first_name': 'ТЕСТ', 'last_name': 'ТЕТС ФЫВФ', 'phone': '+77653433333', 'comment': 'Создан автоматически из Telegram бота (ID: 7250839414)'}
okdesk_bot_1 | INFO:services.okdesk_api:Response: {"id":64,"name":"ТЕТС ФЫВФ ТЕСТ",...}
okdesk_bot_1 | INFO:services.okdesk_api:Создаем заявку с данными: {'title': '123 1223', 'description': '123 1223', 'type_id': 1, 'priority_id': 2, 'status_id': 1, 'company_id': None}
```

Основная проблема заключалась в том, что ID созданных контактов не сохранялись в базе данных и не передавались при создании заявки.

## Решение

Были внесены следующие изменения:

1. **В классе DatabaseManager**:
   - Добавлены методы `update_okdesk_contact_id` и `update_okdesk_company_id` для сохранения ID контактов и компаний в базе данных.

2. **В классе OkdeskAPI**:
   - Добавлен метод `update_issue` для обновления существующих заявок.
   - Доработан метод `find_contact_by_phone` для автоматического сохранения ID найденных контактов.
   - Доработан метод `find_company_by_inn` для автоматического сохранения ID найденных компаний.
   - В методах `create_issue` добавлена поддержка функций обратного вызова для асинхронного обновления ID контактов.

3. **В обработчиках**:
   - Обновлен `handlers/issues.py` для передачи правильных параметров при создании заявок.
   - Добавлен механизм обратного вызова для сохранения ID контактов.

4. **Добавлены скрипты для обслуживания и отладки**:
   - `fix_issue_contacts.py` - для исправления привязки контактов в существующих заявках
   - `sync_all_users.py` - для массовой синхронизации ID контактов и компаний

## Поле okdesk_contact_id в базе данных

В таблице `users` были уже подготовлены поля для хранения ID контактов и компаний:
- `okdesk_contact_id` - для хранения ID контакта в Okdesk
- `company_id` - для хранения ID компании в Okdesk

Теперь эти поля правильно заполняются при создании контактов и поиске компаний.

## Как использовать изменения

### Для исправления существующих заявок

Запустите скрипт для исправления привязки контактов в существующих заявках:

```bash
python fix_issue_contacts.py
```

### Для синхронизации всех пользователей

Запустите скрипт для массовой синхронизации ID контактов и компаний:

```bash
python sync_all_users.py
```

## Алгоритм создания заявки с правильной привязкой

1. При создании заявки система проверяет наличие `okdesk_contact_id` у пользователя.
2. Если ID контакта есть, он передается в параметрах для привязки.
3. Если ID контакта нет, но есть телефон:
   a. Система ищет контакт по телефону в Okdesk.
   b. Если контакт найден, его ID сохраняется в базе данных.
   c. Если контакт не найден, создается новый контакт и его ID сохраняется.
4. Аналогичная логика применяется для компаний по ИНН.

## Что делать при ошибке привязки

Если контакты или компании не привязываются к заявкам:

1. Запустите скрипт синхронизации: `python sync_all_users.py`
2. Запустите скрипт исправления: `python fix_issue_contacts.py`
3. Проверьте логи на наличие ошибок.

## Проверка статуса привязки

Для проверки статуса привязки можно использовать SQL-запрос:

```sql
SELECT telegram_id, phone, okdesk_contact_id FROM users;
```

Для проверки привязки компаний:

```sql
SELECT telegram_id, inn, company_id FROM users;
```

## Тестирование

Для тестирования привязки контактов можно создать тестовую заявку через бота и проверить в интерфейсе Okdesk, правильно ли привязан контакт.

Также можно использовать скрипт для тестирования:

```bash
python test_contact_binding.py
```
