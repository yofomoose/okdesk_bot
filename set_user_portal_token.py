#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –ø–æ—Ä—Ç–∞–ª–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python set_user_portal_token.py <telegram_id> <portal_token>
"""

import os
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

from database.crud import UserService

def set_user_portal_token(telegram_id: int, portal_token: str):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –ø–æ—Ä—Ç–∞–ª–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    try:
        user = UserService.update_portal_token_by_telegram_id(telegram_id, portal_token)
        if user:
            print(f"‚úÖ –¢–æ–∫–µ–Ω –ø–æ—Ä—Ç–∞–ª–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
            print(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.full_name or user.username or 'N/A'}")
            print(f"üîë –¢–æ–∫–µ–Ω: {portal_token}")
        else:
            print(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID {telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Ç–æ–∫–µ–Ω–∞: {e}")

def main():
    if len(sys.argv) != 3:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python set_user_portal_token.py <telegram_id> <portal_token>")
        print("–ü—Ä–∏–º–µ—Ä: python set_user_portal_token.py 123456789 7812-5733-8392-7092")
        sys.exit(1)

    try:
        telegram_id = int(sys.argv[1])
        portal_token = sys.argv[2]

        print(f"üîÑ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø–æ—Ä—Ç–∞–ª–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}...")
        set_user_portal_token(telegram_id, portal_token)

    except ValueError:
        print("‚ùå Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º")
        sys.exit(1)

if __name__ == "__main__":
    main()