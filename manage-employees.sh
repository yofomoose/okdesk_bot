#!/bin/bash

echo "üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏ Okdesk –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–æ–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
add_employee() {
    local name="$1"
    local email="$2"
    local position="$3"
    
    echo "‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: $name"
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º JSON –¥–∞–Ω–Ω—ã–µ
    cat > /tmp/employee_data.json << EOF
{
    "name": "$name",
    "email": "$email",
    "position": "$position",
    "active": true
}
EOF
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
    curl -X POST "https://yapomogu55.okdesk.ru/api/v1/employees?api_token=4cf96e5bb33f06481e4aff5ff0a2aa740ce8490a" \
         -H "Content-Type: application/json" \
         -d @/tmp/employee_data.json
    
    echo ""
    rm -f /tmp/employee_data.json
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
list_employees() {
    echo "üìã –°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ Okdesk:"
    curl -s "https://yapomogu55.okdesk.ru/api/v1/employees?api_token=4cf96e5bb33f06481e4aff5ff0a2aa740ce8490a" | \
        python3 -m json.tool 2>/dev/null || echo "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞
check_bot_users() {
    echo "ü§ñ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–¥–∞—é—Ç—Å—è –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤..."
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞
    docker exec okdesk_bot_okdesk_bot_1 sqlite3 /app/data/okdesk_bot.db \
        "SELECT full_name, phone FROM users WHERE is_registered = 1 AND full_name IS NOT NULL;" 2>/dev/null | \
        while IFS='|' read -r name phone; do
            if [ -n "$name" ]; then
                echo "  ‚Ä¢ $name (—Ç–µ–ª: $phone)"
            fi
        done
    echo ""
}

# –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
echo "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
echo "1. –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ Okdesk"
echo "2. –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞"
echo "3. –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ Okdesk"
echo "4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
echo "5. –í—ã—Ö–æ–¥"
echo ""

read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–µ–π—Å—Ç–≤–∏—è: " choice

case $choice in
    1)
        list_employees
        ;;
    2)
        check_bot_users
        ;;
    3)
        read -p "–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: " emp_name
        read -p "–í–≤–µ–¥–∏—Ç–µ email —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: " emp_email
        read -p "–í–≤–µ–¥–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: " emp_position
        
        if [ -n "$emp_name" ] && [ -n "$emp_email" ]; then
            add_employee "$emp_name" "$emp_email" "$emp_position"
        else
            echo "‚ùå –ò–º—è –∏ email –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã"
        fi
        ;;
    4)
        echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è..."
        
        # –ü–æ–ª—É—á–∞–µ–º ID –ø–µ—Ä–≤–æ–π –æ—Ç–∫—Ä—ã—Ç–æ–π –∑–∞—è–≤–∫–∏
        issue_id=$(curl -s "https://yapomogu55.okdesk.ru/api/v1/issues?limit=1&api_token=4cf96e5bb33f06481e4aff5ff0a2aa740ce8490a" | \
                   python3 -c "import sys, json; data=json.load(sys.stdin); print(data[0]['id'] if data else '')" 2>/dev/null)
        
        if [ -n "$issue_id" ]; then
            echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ –∑–∞—è–≤–∫–µ #$issue_id..."
            
            # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∞–≤—Ç–æ—Ä–∞
            curl -X POST "https://yapomogu55.okdesk.ru/api/v1/issues/$issue_id/comments?api_token=4cf96e5bb33f06481e4aff5ff0a2aa740ce8490a" \
                 -H "Content-Type: application/json" \
                 -d '{
                     "content": "**–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –±–æ—Ç–∞:**\n\n–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∞",
                     "public": true
                 }'
            echo ""
        else
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞—è–≤–æ–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
        fi
        ;;
    5)
        echo "üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!"
        exit 0
        ;;
    *)
        echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
        ;;
esac

echo ""
echo "üí° –ü–æ–ª–µ–∑–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
echo "   ‚Ä¢ –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–æ–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ Okdesk"
echo "   ‚Ä¢ –ò–º–µ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–æ–ª–∂–Ω—ã —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞"
echo "   ‚Ä¢ –ï—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏–º—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–Ω–æ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Okdesk"
echo ""
