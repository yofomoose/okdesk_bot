# Настройка персональных токенов клиентского портала OKDesk

## Особенности системы

В данной системе каждый пользователь имеет **свой собственный токен авторизации** для клиентского портала OKDesk. Это обеспечивает безопасность и персонализацию доступа.

## Как получить токен для пользователя?

### Шаг 1: Получение токена от пользователя
Каждый пользователь должен предоставить свой персональный токен авторизации. Формат токена обычно выглядит так:
```
7812-5733-8392-7092
```

### Шаг 2: Установка токена через скрипт
Используйте скрипт `set_user_portal_token.py`:

```bash
python set_user_portal_token.py <telegram_id> <portal_token>
```

Пример:
```bash
python set_user_portal_token.py 413129274 7812-5733-8392-7092
```

### Шаг 3: Проверка установки
После установки токена все новые заявки пользователя будут содержать ссылки с его персональным токеном авторизации.

## Формат ссылок

### С персональным токеном:
```
https://yapomogu55.okdesk.ru/login?token=7812-5733-8392-7092&redirect=/issues/123
```

### Без токена (если не установлен):
```
https://yapomogu55.okdesk.ru/issues/123
```

## Автоматическое обновление существующих заявок

После установки токена для пользователя запустите скрипт обновления URL:

```bash
python update_urls.py
```

Это обновит все существующие заявки пользователя на новый формат ссылок.

## Безопасность

- ✅ Каждый пользователь имеет свой уникальный токен
- ✅ Токены хранятся в зашифрованном виде в базе данных
- ✅ Доступ к токенам ограничен системными процессами
- ✅ Токены используются только для формирования ссылок на портал

## Управление токенами

### Просмотр токена пользователя
```python
from database.crud import UserService
token = UserService.get_portal_token_by_telegram_id(telegram_id)
```

### Обновление токена
```python
from database.crud import UserService
UserService.update_portal_token_by_telegram_id(telegram_id, new_token)
```

### Удаление токена
```python
from database.crud import UserService
UserService.update_portal_token_by_telegram_id(telegram_id, None)
```