# üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º –ø–æ—Ä—Ç–∞–ª–æ–º OkDesk

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–°–∏—Å—Ç–µ–º–∞ –±—ã–ª–∞ –¥–æ–ø–æ–ª–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ—Ä—Ç–∞–ª OkDesk —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞—è–≤–æ–∫ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **PortalURLGenerator** (`update_urls.py`) - –∫–ª–∞—Å—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫ –ø–æ—Ä—Ç–∞–ª–∞
2. **OkdeskAPI.create_login_link()** - –º–µ—Ç–æ–¥ API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫ –≤—Ö–æ–¥–∞  
3. **OkdeskAPI.create_contact_with_portal_access()** - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –ø–æ—Ä—Ç–∞–ª—É
4. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ handlers** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫ –∏ —Å—Å—ã–ª–æ–∫

### –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã

```mermaid
graph TB
    A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è] --> B[–°–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–Ω—Ç–∞–∫—Ç —Å access_level]
    B --> C[–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è contact_id]
    
    D[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞—è–≤–∫—É] --> E[–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è login_link —á–µ—Ä–µ–∑ API]
    E --> F[–§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è URL —Å redirect –Ω–∞ –∑–∞—è–≤–∫—É]
    F --> G[–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
    
    H[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç —Å—Å—ã–ª–∫—É] --> I[–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –≤ –ø–æ—Ä—Ç–∞–ª]
    I --> J[–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∑–∞—è–≤–∫—É]
    J --> K[–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è]
```

## üîå API Integration

### –°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –≤—Ö–æ–¥–∞

**Endpoint:** `POST /api/v1/login_link`

```python
data = {
    'user_type': 'contact',
    'user_id': contact_id,
    'expire_after': 43200,  # 30 –¥–Ω–µ–π
    'one_time': False       # –ú–Ω–æ–≥–æ—Ä–∞–∑–æ–≤–∞—è —Å—Å—ã–ª–∫–∞
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
    "login_link": "https://example.okdesk.ru/login?token=abc123",
    "user_id": 78,
    "user_type": "contact",
    "user_first_name": "–ò–≤–∞–Ω",
    "user_last_name": "–ü–µ—Ç—Ä–æ–≤"
}
```

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –ø–æ—Ä—Ç–∞–ª—É

```python
contact_response = await okdesk_api.create_contact_with_portal_access(
    first_name="–ò–≤–∞–Ω",
    last_name="–ü–µ—Ç—Ä–æ–≤", 
    phone="+79261234567",
    access_level=[
        'company_issues',  # –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∑–∞—è–≤–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏
        'allow_close_company_issues'  # –†–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–∫—Ä—ã–≤–∞—Ç—å –∑–∞—è–≤–∫–∏
    ]
)
```

## üìÅ –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏

### `update_urls.py`

#### –ö–ª–∞—Å—Å PortalURLGenerator
- `create_login_link()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –≤—Ö–æ–¥–∞
- `get_issue_portal_url()` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞—è–≤–∫—É
- `get_portal_main_url()` - –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ—Ä—Ç–∞–ª–∞
- `get_simple_issue_url()` - –ø—Ä–æ—Å—Ç–∞—è —Å—Å—ã–ª–∫–∞ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

#### –§—É–Ω–∫—Ü–∏–∏
- `update_user_portal_access()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `get_enhanced_issue_urls()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
- `test_portal_integration()` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `services/okdesk_api.py`

#### –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã
- `create_login_link()` - API –º–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –≤—Ö–æ–¥–∞
- `create_contact_with_portal_access()` - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Å –ø—Ä–∞–≤–∞–º–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ handlers

#### `handlers/registration.py`
- –û–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥–∏–Ω–æ–≤ –∏ –ø–∞—Ä–æ–ª–µ–π –¥–ª—è –ø–æ—Ä—Ç–∞–ª–∞
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `access_level` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—è–≤–∫–∞–º

#### `handlers/issues.py`
- –û–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–æ–∫
- –ù–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- –î–æ–±–∞–≤–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ `main_menu` –∏ `profile`
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PortalURLGenerator

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `OKDESK_PORTAL_URL` - –±–∞–∑–æ–≤—ã–π URL –ø–æ—Ä—Ç–∞–ª–∞
- `OKDESK_API_TOKEN` - —Ç–æ–∫–µ–Ω API —Å –ø—Ä–∞–≤–∞–º–∏ —Å–æ–∑–¥–∞–Ω–∏—è login_link

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞
```python
ACCESS_LEVELS = [
    'company_issues',           # –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–æ–∫ –∫–æ–º–ø–∞–Ω–∏–∏
    'allow_close_company_issues' # –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞—è–≤–æ–∫ –∫–æ–º–ø–∞–Ω–∏–∏
]
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
python update_urls.py test
```

### –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è
1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –≤—Ö–æ–¥–∞
3. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ —Å redirect –Ω–∞ –∑–∞—è–≤–∫—É
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–æ–≤ API

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```python
{
    'success': True,
    'test_contact_id': 79,
    'login_url': 'https://example.okdesk.ru/login?token=abc123',
    'issue_url': 'https://example.okdesk.ru/login?token=xyz456&redirect=issues/1'
}
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º INFO:
- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫
- API –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã
- –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 1. –ù–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –≤—Ö–æ–¥–∞
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ —É API —Ç–æ–∫–µ–Ω–∞
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö OkDesk

#### 2. –û—à–∏–±–∫–∞ "contact_id –Ω–µ –Ω–∞–π–¥–µ–Ω"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `/start`

#### 3. –°—Å—ã–ª–∫–∞ –≤–µ–¥–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
**–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å—Ç–µ–∫ —Ç–æ–∫–µ–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π user_id
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```bash
pip install aiohttp python-dotenv psycopg2-binary aiogram
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö URL
```bash
python update_urls.py
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
```bash 
python update_urls.py test
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –≤—Ö–æ–¥–∞
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Å –ø—Ä–∞–≤–∞–º–∏ –ø–æ—Ä—Ç–∞–ª–∞
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API login_link
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –≤ –ø–æ—Ä—Ç–∞–ª

### –õ–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```python
logger.info(f"‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å—Å—ã–ª–∫–∞ –≤—Ö–æ–¥–∞: {login_url}")
logger.info(f"‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç —Å–æ–∑–¥–∞–Ω —Å ID={contact_id} –∏ –¥–æ—Å—Ç—É–ø–æ–º –∫ –ø–æ—Ä—Ç–∞–ª—É")
logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –≤—Ö–æ–¥–∞: {response}")
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –¢–æ–∫–µ–Ω—ã –≤—Ö–æ–¥–∞
- –í—Ä–µ–º—è –∂–∏–∑–Ω–∏: 30 –¥–Ω–µ–π (43200 –º–∏–Ω—É—Ç)
- –¢–∏–ø: –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
- –ü—Ä–∏–≤—è–∑–∫–∞: –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É contact_id

### –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞—è–≤–∫–∞–º–∏ —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
- –ó–∞–ø—Ä–µ—Ç –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –≤—Ö–æ–¥–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–æ—Ç–∞
- Fallback –∫ –ø—Ä–æ—Å—Ç—ã–º —Å—Å—ã–ª–∫–∞–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ API

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ù–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–∫–µ–Ω—ã –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –∏—Å—Ç–µ–∫–ª–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API

---

## ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API OkDesk –∏–ª–∏ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.