#!/bin/bash

# üöÄ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã readonly –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./fix-db.sh

echo "üöÄ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã readonly –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
echo "==========================================="

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
RESET='\033[0m'

log() {
    echo -e "${GREEN}[$(date +'%H:%M:%S')] $1${RESET}"
}

error() {
    echo -e "${RED}[ERROR] $1${RESET}"
}

warning() {
    echo -e "${YELLOW}[WARNING] $1${RESET}"
}

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
fix_permissions() {
    log "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."

    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –Ω–∞ —Ñ–∞–π–ª
    if [ -f "./data/okdesk_bot.db" ]; then
        chmod 666 ./data/okdesk_bot.db
        log "‚úÖ –ü—Ä–∞–≤–∞ —Ñ–∞–π–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
    else
        warning "‚ö†Ô∏è –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi

    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    if [ -d "./data" ]; then
        chmod 755 ./data
        log "‚úÖ –ü—Ä–∞–≤–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
    else
        mkdir -p ./data
        chmod 755 ./data
        log "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–∞–≤–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
    fi
}

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Docker
fix_docker_permissions() {
    log "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ —á–µ—Ä–µ–∑ Docker..."

    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    docker-compose exec bot chmod 666 /app/data/okdesk_bot.db 2>/dev/null || warning "–ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
    docker-compose exec bot chmod 755 /app/data 2>/dev/null || warning "–ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
}

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
restart_services() {
    log "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."

    docker-compose down
    sleep 2
    docker-compose up -d
    sleep 5

    if docker-compose ps | grep -q "Up"; then
        log "‚úÖ –°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
    else
        error "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤"
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
check_fix() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    if [ -f "./data/okdesk_bot.db" ] && [ -w "./data/okdesk_bot.db" ]; then
        log "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
    else
        error "‚ùå –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
        return 1
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    if docker-compose ps | grep -q "Up"; then
        log "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç"
    else
        error "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç"
        return 1
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –æ—à–∏–±–∫–∏
    if docker-compose logs bot --tail=10 | grep -q "readonly database"; then
        error "‚ùå –û—à–∏–±–∫–∞ readonly database –≤—Å–µ –µ—â–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        return 1
    else
        log "‚úÖ –û—à–∏–±–æ–∫ readonly database –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ª–æ–≥–∞—Ö"
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    echo ""

    # –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤
    fix_permissions
    echo ""

    # –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Docker (–µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã)
    if docker-compose ps | grep -q "Up"; then
        fix_docker_permissions
        echo ""
    fi

    # –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
    restart_services
    echo ""

    # –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞
    if check_fix; then
        echo ""
        log "üéâ –ü—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
        echo ""
        echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
        echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker-compose logs bot --tail=10"
        echo "2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram"
        echo "3. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤–µ—Ä–Ω—É–ª–∞—Å—å, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ: ./diagnose-db.sh"
    else
        echo ""
        error "‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å"
        echo ""
        echo "üîß –†—É—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:"
        echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker-compose logs"
        echo "2. –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: ./diagnose-db.sh"
        echo "3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É: rm ./data/okdesk_bot.db && docker-compose restart"
    fi

    echo ""
    log "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
}

# –ó–∞–ø—É—Å–∫
main "$@"